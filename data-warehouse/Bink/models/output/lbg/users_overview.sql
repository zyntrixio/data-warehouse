/*
Created by:         Anand Bhakta
Created date:       2023-05-23
Last modified by:   Christopher Mitchell
Last modified date: 2023-06-07

Description:
    Datasource to produce lloyds mi dashboard - users_overview
Parameters:
    source_object       - lc__links_joins__daily_retailer_channel
                        - lc__links_joins__daily_channel
                        - user__transactions__daily_user_level
                        - user__registrations__daily__channel_brand 
*/

WITH lc_metrics_retailer AS (
    SELECT 
        *
        ,'LC_RETAILER_CHANNEL' AS TAB
    FROM {{ref('lc__links_joins__daily_retailer_channel')}}
    WHERE CHANNEL = 'LLOYDS'
)

,lc_metrics AS (
    SELECT 
        *
        ,'LC_CHANNEL' AS TAB
    FROM {{ref('user__loyalty_card__daily_channel_brand')}}
    WHERE CHANNEL = 'LLOYDS'
)

,trans AS (
    SELECT
        *
        ,'TRANS' AS TAB
    FROM {{ref('user__transactions__daily_user_level')}}
    WHERE CHANNEL = 'LLOYDS'
)

,users_metrics AS (
    SELECT
        *
        ,'USERS' AS TAB
    FROM {{ref('user__registrations__daily__channel_brand')}}
    WHERE CHANNEL = 'LLOYDS'
)

,metric_select AS (
    SELECT
        TAB
        ,DATE
        ,CHANNEL
        ,BRAND
        ,LOYALTY_PLAN_COMPANY
        ,LC001__SUCCESSFUL_LOYALTY_CARDS__DAILY_CHANNEL_BRAND_RETAILER__PIT
        ,NULL AS U003__USERS_WITH_A_LINKED_LOYALTY_CARD__DAILY_CHANNEL_BRAND__PIT
        ,LC004__DELETED_LOYALTY_CARDS__DAILY_CHANNEL_BRAND_RETAILER__PIT
        ,LC005__SUCCESSFUL_LOYALTY_CARDS__DAILY_CHANNEL_BRAND_RETAILER__COUNT
        ,LC008__DELETED_LOYALTY_CARDS__DAILY_CHANNEL_BRAND_RETAILER__COUNT
        ,NULL AS U005__REGISTERED_USERS__DAILY_CHANNEL_BRAND__COUNT
        ,NULL AS U006__DEREGISTERED_USERS__DAILY_CHANNEL_BRAND__COUNT
        ,NULL AS U001__REGISTERED_USERS__DAILY_CHANNEL_BRAND__PIT
        ,NULL AS U002__DEREGISTERED_USERS__DAILY_CHANNEL_BRAND__PIT
        ,NULL AS SPEND
        ,NULL AS U007__ACTIVE_USERS__USER_LEVEL_DAILY__UID
        ,NULL AS TRANSACTIONS
    FROM
        lc_metrics_retailer
    WHERE LOYALTY_PLAN_COMPANY IN ('SquareMeal', 'Viator', 'Iceland')

    UNION ALL

    SELECT
        TAB
        ,DATE
        ,CHANNEL
        ,BRAND
        ,NULL AS LOYALTY_PLAN_COMPANY
        ,NULL AS LC001__SUCCESSFUL_LOYALTY_CARDS__DAILY_CHANNEL_BRAND_RETAILER__PIT
        ,U003__USERS_WITH_A_LINKED_LOYALTY_CARD__DAILY_CHANNEL_BRAND__PIT
        ,NULL AS LC004__DELETED_LOYALTY_CARDS__DAILY_CHANNEL_BRAND_RETAILER__PIT
        ,NULL AS LC005__SUCCESSFUL_LOYALTY_CARDS__DAILY_CHANNEL_BRAND_RETAILER__COUNT
        ,NULL AS LC008__DELETED_LOYALTY_CARDS__DAILY_CHANNEL_BRAND_RETAILER__COUNT
        ,NULL AS U005__REGISTERED_USERS__DAILY_CHANNEL_BRAND__COUNT
        ,NULL AS U006__DEREGISTERED_USERS__DAILY_CHANNEL_BRAND__COUNT
        ,NULL AS U001__REGISTERED_USERS__DAILY_CHANNEL_BRAND__PIT
        ,NULL AS U002__DEREGISTERED_USERS__DAILY_CHANNEL_BRAND__PIT
        ,NULL AS SPEND
        ,NULL AS U007__ACTIVE_USERS__USER_LEVEL_DAILY__UID
        ,NULL AS TRANSACTIONS
    FROM
        lc_metrics    

    UNION ALL

    SELECT
        TAB
        ,DATE
        ,CHANNEL
        ,BRAND
        ,LOYALTY_PLAN_COMPANY
        ,NULL AS LC001__SUCCESSFUL_LOYALTY_CARDS__DAILY_CHANNEL_BRAND_RETAILER__PIT
        ,NULL AS U003__USERS_WITH_A_LINKED_LOYALTY_CARD__DAILY_CHANNEL_BRAND__PIT
        ,NULL AS LC004__DELETED_LOYALTY_CARDS__DAILY_CHANNEL_BRAND_RETAILER__PIT
        ,NULL AS LC005__SUCCESSFUL_LOYALTY_CARDS__DAILY_CHANNEL_BRAND_RETAILER__COUNT
        ,NULL AS LC008__DELETED_LOYALTY_CARDS__DAILY_CHANNEL_BRAND_RETAILER__COUNT
        ,NULL AS U005__REGISTERED_USERS__DAILY_CHANNEL_BRAND__COUNT
        ,NULL AS U006__DEREGISTERED_USERS__DAILY_CHANNEL_BRAND__COUNT
        ,NULL AS U001__REGISTERED_USERS__DAILY_CHANNEL_BRAND__PIT
        ,NULL AS U002__DEREGISTERED_USERS__DAILY_CHANNEL_BRAND__PIT
        ,SPEND
        ,U007__ACTIVE_USERS__USER_LEVEL_DAILY__UID
        ,TRANSACTIONS
    FROM    
        trans
    WHERE LOYALTY_PLAN_COMPANY IN ('SquareMeal', 'Viator', 'Iceland')

    UNION ALL

    SELECT
        TAB
        ,DATE
        ,CHANNEL
        ,BRAND
        ,NULL AS LOYALTY_PLAN_COMPANY
        ,NULL AS LC001__SUCCESSFUL_LOYALTY_CARDS__DAILY_CHANNEL_BRAND_RETAILER__PIT
        ,NULL AS U003__USERS_WITH_A_LINKED_LOYALTY_CARD__DAILY_CHANNEL_BRAND__PIT
        ,NULL AS LC004__DELETED_LOYALTY_CARDS__DAILY_CHANNEL_BRAND_RETAILER__PIT
        ,NULL AS LC005__SUCCESSFUL_LOYALTY_CARDS__DAILY_CHANNEL_BRAND_RETAILER__COUNT
        ,NULL AS LC008__DELETED_LOYALTY_CARDS__DAILY_CHANNEL_BRAND_RETAILER__COUNT
        ,U005__REGISTERED_USERS__DAILY_CHANNEL_BRAND__COUNT
        ,U006__DEREGISTERED_USERS__DAILY_CHANNEL_BRAND__COUNT
        ,U001__REGISTERED_USERS__DAILY_CHANNEL_BRAND__PIT
        ,U002__DEREGISTERED_USERS__DAILY_CHANNEL_BRAND__PIT
        ,NULL AS SPEND
        ,NULL AS U007__ACTIVE_USERS__USER_LEVEL_DAILY__UID
        ,NULL AS TRANSACTIONS
    FROM
        users_metrics
)

select * from metric_select
